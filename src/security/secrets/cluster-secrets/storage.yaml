# =============================================================================
# src/security/secrets/cluster-secrets/storage.yaml
# ClusterExternalSecrets - Storage Credentials Distribution
# =============================================================================
#
# Distributes storage-related secrets to namespaces based on labels.
# Uses ClusterExternalSecret to sync secrets from Vault to multiple namespaces.
#
# Secret Distribution Strategy:
#   Namespaces opt-in to receive secrets by adding labels:
#     opencloudhub.org/secret-minio: "true"    → Receives minio-tenant-secret
#     opencloudhub.org/secret-pgadmin: "true"  → Receives pgadmin-admin-secret
#
# MinIO Tenant Secret (minio-tenant-secret):
#   Distributed to: minio-tenant, observability, mlops, models, demo-app
#   Contains:
#     - AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY (for S3 clients)
#     - config.env (for MinIO operator)
#
# pgAdmin Secret (pgadmin-admin-secret):
#   Distributed to: storage (where pgAdmin runs)
#   Contains: password for pgAdmin web UI
#
# Vault Paths:
#   - kv/platform/storage/minio-tenant/credentials
#   - kv/platform/storage/pgadmin/credentials
#
# =============================================================================

apiVersion: external-secrets.io/v1
kind: ClusterExternalSecret
metadata:
  name: minio-tenant-secret
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  externalSecretName: minio-tenant-secret-es
  refreshTime: 1h
  namespaceSelectors:
    - matchLabels:
        opencloudhub.org/secret-minio: "true"
  externalSecretSpec:
    refreshInterval: 1h
    secretStoreRef:
      name: vault-backend
      kind: ClusterSecretStore
    target:
      name: minio-tenant-secret
      creationPolicy: Owner
      deletionPolicy: Retain
      template:
        data:
          # AWS env var names (for secretRef in pods)
          AWS_ACCESS_KEY_ID: "{{ .accesskey }}"
          AWS_SECRET_ACCESS_KEY: "{{ .secretkey }}"
          AWS_ENDPOINT_URL: "https://minio-api.internal.opencloudhub.org"
          # MinIO config.env format (for MinIO operator)
          config.env: |
            export MINIO_ROOT_USER={{ .accesskey }}
            export MINIO_ROOT_PASSWORD={{ .secretkey }}
    data:
      - secretKey: accesskey
        remoteRef:
          key: platform/storage/minio-tenant/credentials
          property: accesskey
          conversionStrategy: Default
          decodingStrategy: None
          metadataPolicy: None
      - secretKey: secretkey
        remoteRef:
          key: platform/storage/minio-tenant/credentials
          property: secretkey
          conversionStrategy: Default
          decodingStrategy: None
          metadataPolicy: None
---
apiVersion: external-secrets.io/v1
kind: ClusterExternalSecret
metadata:
  name: pgadmin-admin-secret
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  externalSecretName: pgadmin-admin-es
  refreshTime: 1h
  namespaceSelectors:
    - matchLabels:
        opencloudhub.org/secret-pgadmin: "true"
  externalSecretSpec:
    refreshInterval: 1h
    secretStoreRef:
      name: vault-backend
      kind: ClusterSecretStore
    target:
      name: pgadmin-admin-secret
      creationPolicy: Owner
      deletionPolicy: Retain
      template:
        data:
          password: "{{ .password }}"
    data:
      - secretKey: password
        remoteRef:
          key: platform/storage/pgadmin/credentials
          property: password
          conversionStrategy: Default
          decodingStrategy: None
          metadataPolicy: None

apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: rag-evaluation-pipeline
  namespace: mlops
  annotations:
    workflows.argoproj.io/description: "Evaluate RAG prompt versions and reload endpoint with best"
spec:
  serviceAccountName: workflow-executor

  arguments:
    parameters:
      - name: image
        description: "Docker image for evaluation"
      - name: prompt_versions
        description: "Comma-separated prompt versions to evaluate (e.g., 1,2,3)"
        default: "1,2,3"
      - name: dvc_data_version
        description: "DVC data version for evaluation dataset"
        default: "opencloudhub-readmes-rag-evaluation-v1.0.0"
      - name: auto_promote
        description: "Auto-promote best prompt to @champion"
        default: "true"
      - name: prompt_name
        description: "MLflow prompt name"
        default: "readme-rag-prompt"

  entrypoint: main

  templates:
    - name: main
      steps:
        - - name: run-evaluation
            template: evaluate-prompts

        - - name: reload-rag-endpoint
            template: reload-endpoint
            when: "{{workflow.parameters.auto_promote}} == true"

    # ==========================================================================
    # EVALUATE PROMPTS
    # ==========================================================================
    - name: evaluate-prompts
      outputs:
        artifacts:
          - name: evaluation-report
            path: /tmp/output.log
            archive:
              none: {}
      container:
        image: "{{workflow.parameters.image}}"
        command: [sh, -c]
        args:
          - |
            python -m src.prompts.evaluate_prompts \
              --prompt-name "{{workflow.parameters.prompt_name}}" \
              --prompt-versions "{{workflow.parameters.prompt_versions}}" \
              --dvc-data-version "{{workflow.parameters.dvc_data_version}}" \
              --auto-promote 2>&1 | tee /tmp/output.log
        envFrom:
          - configMapRef:
              name: models-job-env
          - configMapRef:
              name: rag-evaluation-env
          - secretRef:
              name: models-job-secrets
        env:
          - name: DB_USER
            valueFrom:
              secretKeyRef:
                name: demo-app-db-user
                key: username
          - name: DB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: demo-app-db-user
                key: password
          - name: DOCKER_IMAGE_TAG
            value: "{{workflow.parameters.image}}"
          - name: ARGO_WORKFLOW_UID
            value: "{{workflow.uid}}"
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"

    # ==========================================================================
    # RELOAD RAG ENDPOINT
    # ==========================================================================
    - name: reload-endpoint
      outputs:
        artifacts:
          - name: reload-report
            path: /tmp/reload-report.md
            archive:
              none: {}
      script:
        image: curlimages/curl:8.5.0
        command: [sh]
        source: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”„ RELOAD RAG ENDPOINT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  Endpoint ..... demo-app-genai-backend:8000"
          echo "  Action ....... Load @champion prompt"
          echo ""

          RESPONSE=$(curl -X POST \
            http://demo-app-genai-backend.demo-app.svc.cluster.local:8000/admin/reload-prompt \
            -H "Content-Type: application/json" \
            -d '{"prompt_version": null}' \
            --fail --silent --show-error 2>&1) || {
              echo "--------------------------------------------------"
              echo "âŒ RELOAD FAILED"
              echo "   $RESPONSE"
              echo "--------------------------------------------------"

              cat > /tmp/reload-report.md << EOF
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ðŸ”„ RELOAD RAG ENDPOINT
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            Status ....... FAILED
            Error ........ $RESPONSE

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
              exit 1
          }

          echo "--------------------------------------------------"
          echo "âœ… ENDPOINT RELOADED"
          echo "   Prompt @champion now active"
          echo "--------------------------------------------------"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          cat > /tmp/reload-report.md << EOF
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ðŸ”„ RELOAD RAG ENDPOINT
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            Endpoint ..... demo-app-genai-backend:8000
            Status ....... SUCCESS
            Prompt ....... @champion

          --------------------------------------------------
          âœ… ENDPOINT RELOADED SUCCESSFULLY
          --------------------------------------------------

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF

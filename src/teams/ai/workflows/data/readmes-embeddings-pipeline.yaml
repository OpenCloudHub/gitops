apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: embeddings-pipeline
  namespace: mlops
  annotations:
    workflows.argoproj.io/description: "Generate embeddings from downloaded data and store in pgvector"
spec:
  serviceAccountName: workflow-executor

  arguments:
    parameters:
      - name: data_version
        description: "Source data version tag (e.g., opencloudhub-readmes-download-v1.0.0)"
      - name: force
        value: "false"
        description: "Force re-run even if DVC cache exists"
      - name: compute_type
        value: "cpu-medium"
        enum:
          [cpu-small, cpu-medium, cpu-large, gpu-small, gpu-medium, gpu-large]
        description: "Compute configuration for Ray cluster"
      - name: image
        value: "opencloudhuborg/data-registry-pipelines:latest"
        description: "Docker image for embeddings pipeline"
      - name: bump_type
        value: "patch"
        enum: [major, minor, patch]
        description: "Version bump type for output tag"
      - name: is_automated
        value: "false"
        description: "Add -automated suffix to output tag"

  entrypoint: main

  templates:
    - name: main
      dag:
        tasks:
          # Phase 1: Map compute type to resources
          - name: map-compute
            templateRef:
              name: compute-templates
              template: map-compute-config
            arguments:
              parameters:
                - name: compute_type
                  value: "{{workflow.parameters.compute_type}}"

          # Phase 2: Run embeddings job
          - name: run-embeddings
            depends: "map-compute.Succeeded"
            templateRef:
              name: ray-templates
              template: submit-and-stream-rayjob
            arguments:
              parameters:
                - name: job_prefix
                  value: "embeddings"
                - name: image
                  value: "{{workflow.parameters.image}}"
                - name: entrypoint
                  value: "dvc repro {{=workflow.parameters.force == 'true' ? '--force' : ''}"
                - name: base_configmap
                  value: "data-job-env"
                - name: job_configmap
                  value: "embeddings-env"
                - name: job_secret
                  value: "data-job-secrets"
                - name: cpu
                  value: "{{tasks.map-compute.outputs.parameters.cpu_request}}"
                - name: memory
                  value: "{{tasks.map-compute.outputs.parameters.memory_request}}"
                - name: gpu
                  value: "{{tasks.map-compute.outputs.parameters.gpu}}"
                - name: replicas
                  value: "{{tasks.map-compute.outputs.parameters.replicas}}"
                - name: dvc_data_version
                  value: "{{workflow.parameters.data_version}}"

          # Phase 3: Git tag if succeeded
          - name: git-tag
            depends: "run-embeddings.Succeeded"
            templateRef:
              name: git-templates
              template: git-tag-version
            arguments:
              parameters:
                - name: tag_prefix
                  value: "opencloudhub-readmes-embeddings"
                - name: bump_type
                  value: "{{workflow.parameters.bump_type}}"
                - name: is_automated
                  value: "{{workflow.parameters.is_automated}}"
                - name: message
                  value: "Embeddings generated from {{workflow.parameters.data_version}}"

apiVersion: v1
kind: ConfigMap
metadata:
  name: embeddings-rayjob-template
  namespace: mlops
data:
  rayjob.yaml: |
    apiVersion: ray.io/v1
    kind: RayJob
    metadata:
      generateName: embeddings-
      namespace: mlops
      labels:
        run: "${RUN_LABEL}"
        pipeline: "embeddings"
    spec:
      entrypoint: "${ENTRYPOINT}"
      runtimeEnvYAML: "working_dir: /workspace/project"
      shutdownAfterJobFinishes: true
      ttlSecondsAfterFinished: 300
      submitterPodTemplate:
      spec:
        restartPolicy: Never
        containers:
          - name: ray-job-submitter
            image: rayproject/ray:2.51.0-py312 
            resources:
              limits:
                cpu: "1"
                memory: "2Gi"
              requests:
                cpu: "500m"
                memory: "1Gi"
      rayClusterSpec:
        rayVersion: "2.51.0"
        headGroupSpec:
          serviceType: ClusterIP
          template:
            spec:
              containers:
              - name: ray-head
                image: "${IMAGE}"
                resources:
                  requests:
                    cpu: "${CPU_REQUEST}"
                    memory: "${MEMORY_REQUEST}"
                  limits:
                    cpu: "${CPU_LIMIT}"
                    memory: "${MEMORY_LIMIT}"
                env:
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: minio-tenant-secret
                      key: accesskey
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: minio-tenant-secret
                      key: secretkey
                - name: AWS_ENDPOINT_URL
                  valueFrom:
                    secretKeyRef:
                      name: minio-tenant-secret
                      key: endpoint-url
                - name: PGVECTOR_HOST
                  value: "cnpg-cluster-rw.storage.svc.cluster.local"
                - name: POSTGRES_DEMO_APP_DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: demo-app-db-user
                      key: password
                - name: DVC_REPO
                  value: "https://github.com/OpenCloudHub/data-registry"
        workerGroupSpecs:
        - replicas: ${REPLICAS}
          groupName: worker
          template:
            spec:
              containers:
              - name: ray-worker
                image: "${IMAGE}"
                resources:
                  requests:
                    cpu: "${CPU_REQUEST}"
                    memory: "${MEMORY_REQUEST}"
                  limits:
                    cpu: "${CPU_LIMIT}"
                    memory: "${MEMORY_LIMIT}"
                env:
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: minio-tenant-secret
                      key: accesskey
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: minio-tenant-secret
                      key: secretkey
                - name: AWS_ENDPOINT_URL
                  valueFrom:
                    secretKeyRef:
                      name: minio-tenant-secret
                      key: endpoint-url
                - name: PGVECTOR_HOST
                  value: "cnpg-cluster-rw.storage.svc.cluster.local"
                - name: POSTGRES_DEMO_APP_DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: demo-app-db-user
                      key: password
                - name: DVC_REPO
                  value: "https://github.com/OpenCloudHub/data-registry"
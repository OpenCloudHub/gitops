# modules/deployment.yaml
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: deployment-templates
  namespace: mlops
  workflows.argoproj.io/description: 'Templates for model deployment.'
spec:
  serviceAccountName: workflow-executor

  templates:
  # Main deployment workflow - combines GitOps update + MLflow tagging
  - name: deploy-model
    inputs:
      parameters:
      - name: model_name          # e.g., wine-classifier
      - name: model_uri           # e.g., models:/prod.wine-classifier/1
      - name: serving_image       # e.g., opencloudhuborg/wine-classifier-serving:main-abc123
      - name: deployed_by         # e.g., "pipeline", "manual", or username
        value: "manual"
      - name: mlflow_tracking_uri
        value: "http://mlflow.mlops.svc.cluster.local:80"
    steps:
    # Step 1: Update GitOps repo
    - - name: update-gitops-repo
        template: update-gitops
        arguments:
          parameters:
          - name: model_name
            value: "{{inputs.parameters.model_name}}"
          - name: model_uri
            value: "{{inputs.parameters.model_uri}}"
          - name: serving_image
            value: "{{inputs.parameters.serving_image}}"

    # Step 2: Tag deployment in MLflow
    - - name: tag-mlflow-deployment
        template: tag-deployment-in-mlflow
        arguments:
          parameters:
          - name: model_uri
            value: "{{inputs.parameters.model_uri}}"
          - name: serving_image
            value: "{{inputs.parameters.serving_image}}"
          - name: deployed_by
            value: "{{inputs.parameters.deployed_by}}"
          - name: mlflow_tracking_uri
            value: "{{inputs.parameters.mlflow_tracking_uri}}"

  # Sub-template: GitOps update
  - name: update-gitops
    inputs:
      parameters:
      - name: model_name
      - name: model_uri
      - name: serving_image
    volumes:
    - name: git-secret
      secret:
        secretName: gitops-repo
    script:
      image: alpine/git:latest
      command: [sh]
      volumeMounts:
      - name: git-secret
        mountPath: /mnt/secrets
        readOnly: true
      source: |
        set -e

        # SSH setup
        mkdir -p ~/.ssh
        cat /mnt/secrets/sshPrivateKey > ~/.ssh/id_ed25519
        echo "" >> ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan github.com >> ~/.ssh/known_hosts

        MODEL_NAME="{{inputs.parameters.model_name}}"
        MODEL_URI="{{inputs.parameters.model_uri}}"
        SERVING_IMAGE="{{inputs.parameters.serving_image}}"

        # Clean variables
        MODEL_NAME=$(echo "$MODEL_NAME" | tr -d '\n\r\t ')
        MODEL_URI=$(echo "$MODEL_URI" | tr -d '\n\r\t ')
        SERVING_IMAGE=$(echo "$SERVING_IMAGE" | tr -d '\n\r\t ')

        # Extract version from model URI using sed instead of grep -P
        # models:/prod.wine-classifier/1 ‚Üí 1
        VERSION=$(echo "$MODEL_URI" | sed -n 's|.*/\([0-9]*\)$|\1|p')

        git clone git@github.com:OpenCloudHub/gitops.git /tmp/gitops
        cd /tmp/gitops

        SERVICE_FILE="src/teams/ai/models-custom/${MODEL_NAME}-service.yaml"

        echo "üì¶ Deployment: ${MODEL_NAME}"
        echo "   Model: ${MODEL_URI}"
        echo "   Image: ${SERVING_IMAGE}"
        echo ""

        # Extract current state
        CURRENT_IMAGE=$(grep "image: opencloudhuborg/${MODEL_NAME}" "$SERVICE_FILE" | head -1 | awk '{print $2}')

        if grep -q "model_uri:" "$SERVICE_FILE"; then
          # Extract current URI using sed instead of grep -P
          CURRENT_URI=$(grep "model_uri:" "$SERVICE_FILE" | sed -n 's/.*model_uri: "\([^"]*\)".*/\1/p')
          echo "   Current: ${CURRENT_URI} with ${CURRENT_IMAGE}"
        else
          echo "   Current: (no model) with ${CURRENT_IMAGE}"
        fi

        # Update images
        sed -i "s|image: opencloudhuborg/${MODEL_NAME}-serving:[a-zA-Z0-9_-]*|image: ${SERVING_IMAGE}|g" "$SERVICE_FILE"

        # Update or add model_uri
        if grep -q "user_config:" "$SERVICE_FILE"; then
          echo "   Updating existing user_config..."
          sed -i "s|model_uri: \"models:/[^\"]*\"|model_uri: \"${MODEL_URI}\"|g" "$SERVICE_FILE"
        else
          echo "   Adding user_config..."
          # Add user_config after first deployment name, with proper indentation
          awk '
            /deployments:/ { in_deployments=1 }
            in_deployments && /- name:/ && !added {
              print
              print "            user_config:"
              print "              model_uri: \"'"${MODEL_URI}"'\""
              added=1
              next
            }
            { print }
          ' "$SERVICE_FILE" > "${SERVICE_FILE}.tmp"
          mv "${SERVICE_FILE}.tmp" "$SERVICE_FILE"
        fi

        git config user.name "Argo Workflow"
        git config user.email "workflow@opencloudhub.org"
        git add "$SERVICE_FILE"
        git commit -m "üöÄ Deploy ${MODEL_NAME} v${VERSION} (${SERVING_IMAGE##*:})"
        git push

        echo ""
        echo "‚úÖ GitOps updated!"

  # Sub-template: MLflow tagging
  - name: tag-deployment-in-mlflow
    inputs:
      parameters:
      - name: model_uri
      - name: serving_image
      - name: deployed_by
        value: "manual"
      - name: mlflow_tracking_uri
        value: "http://mlflow.mlops.svc.cluster.local:80"
    script:
      image: ghcr.io/mlflow/mlflow:v2.18.0
      command: [python]
      env:
      - name: MODEL_URI
        value: "{{inputs.parameters.model_uri}}"
      - name: SERVING_IMAGE
        value: "{{inputs.parameters.serving_image}}"
      - name: DEPLOYED_BY
        value: "{{inputs.parameters.deployed_by}}"
      - name: MLFLOW_TRACKING_URI
        value: "{{inputs.parameters.mlflow_tracking_uri}}"
      - name: WORKFLOW_UID
        value: "{{workflow.uid}}"
      - name: WORKFLOW_NAME
        value: "{{workflow.name}}"
      source: |
        from mlflow import MlflowClient
        from datetime import datetime
        import re
        import os

        client = MlflowClient(os.environ["MLFLOW_TRACKING_URI"])
        model_uri = os.environ["MODEL_URI"].strip()

        # Parse: models:/prod.wine-classifier/1
        match = re.match(r'models:/([^.]+)\.([^/]+)/(\d+)', model_uri)
        if not match:
            print(f"‚ùå Invalid model URI format: '{model_uri}'")  # ‚Üê Add quotes to see whitespace
            exit(1)

        registry_prefix = match.group(1)
        model_name = match.group(2)
        version = match.group(3)
        full_name = f"{registry_prefix}.{model_name}"

        print(f"üè∑Ô∏è  Tagging deployment in MLflow")
        print(f"   Model: {full_name}/v{version}")

        tags = {
            "deployment_status": "deployed",
            "deployed_at": datetime.utcnow().isoformat(),
            "deployed_by": os.environ["DEPLOYED_BY"].strip(),
            "serving_image": os.environ["SERVING_IMAGE"].strip(),
            "kubernetes_namespace": "ai",
            "argo_workflow_uid": os.environ["WORKFLOW_UID"].strip(),
            "argo_workflow_name": os.environ["WORKFLOW_NAME"].strip()
        }

        for key, value in tags.items():
            client.set_model_version_tag(full_name, version, key, value)

        print(f"‚úÖ Tagged: {full_name}/v{version}")

# =============================================================================
# Deployment Templates
# =============================================================================
#
# GitOps-based model deployment to production.
# Updates serving configuration in gitops repo and tags MLflow model.
#
# Templates:
#   deploy-model       - Orchestrates GitOps update + MLflow tagging
#   update-gitops-repo - Updates or creates Ray Serve config in gitops repo
#
# GitOps Pattern:
#   - Updates image tag in {model}-service.yaml
#   - Adds/updates model_uri annotation for MLflow reference
#   - ArgoCD syncs changes to cluster automatically
#
# Requires:
#   - gitops-repo secret with SSH key for git push
#   - Service file at: src/teams/ai/models-custom/{model}-service.yaml
#
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: deployment-templates
  namespace: mlops
  annotations:
    workflows.argoproj.io/description: "GitOps model deployment"
spec:
  serviceAccountName: workflow-executor

  templates:
    # =========================================================================
    # DEPLOY MODEL (GitOps + MLflow tagging)
    # =========================================================================
    - name: deploy-model
      inputs:
        parameters:
          - name: model_name
          - name: model_uri
          - name: serving_image
          - name: deployed_by
            default: "argo-workflow"
      steps:
        - - name: update-gitops
            template: update-gitops-repo
            arguments:
              parameters:
                - name: model_name
                  value: "{{inputs.parameters.model_name}}"
                - name: model_uri
                  value: "{{inputs.parameters.model_uri}}"
                - name: serving_image
                  value: "{{inputs.parameters.serving_image}}"

        - - name: tag-mlflow
            templateRef:
              name: mlflow-templates
              template: tag-deployment-info
            arguments:
              parameters:
                - name: model_uri
                  value: "{{inputs.parameters.model_uri}}"
                - name: serving_image
                  value: "{{inputs.parameters.serving_image}}"
                - name: deployed_by
                  value: "{{inputs.parameters.deployed_by}}"

    # =========================================================================
    # UPDATE GITOPS REPOSITORY
    # =========================================================================
    - name: update-gitops-repo
      inputs:
        parameters:
          - name: model_name
          - name: model_uri
          - name: serving_image
      outputs:
        artifacts:
          - name: deployment-report
            path: /tmp/deployment-report.md
            archive:
              none: {}
      volumes:
        - name: git-secret
          secret:
            secretName: gitops-repo
      script:
        image: alpine/git:latest
        command: [sh]
        volumeMounts:
          - name: git-secret
            mountPath: /mnt/secrets
            readOnly: true
        source: |
          set -e

          # SSH setup
          mkdir -p ~/.ssh
          cat /mnt/secrets/sshPrivateKey > ~/.ssh/id_ed25519
          echo "" >> ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null

          MODEL_NAME="{{inputs.parameters.model_name}}"
          MODEL_URI="{{inputs.parameters.model_uri}}"
          SERVING_IMAGE="{{inputs.parameters.serving_image}}"

          # Clean variables
          MODEL_NAME=$(echo "$MODEL_NAME" | tr -d '\n\r\t ')
          MODEL_URI=$(echo "$MODEL_URI" | tr -d '\n\r\t ')
          SERVING_IMAGE=$(echo "$SERVING_IMAGE" | tr -d '\n\r\t ')

          # Extract version from URI
          VERSION=$(echo "$MODEL_URI" | sed -n 's|.*/\([0-9]*\)$|\1|p')
          if [ -z "$VERSION" ]; then
            VERSION=$(echo "$MODEL_URI" | sed 's|.*@||')
          fi

          git clone git@github.com:OpenCloudHub/gitops.git /tmp/gitops
          cd /tmp/gitops

          SERVICE_FILE="src/teams/ai/models-custom/${MODEL_NAME}-service.yaml"

          # Check if service file exists
          if [ ! -f "$SERVICE_FILE" ]; then
            {
              echo ""
              echo "##################################################"
              echo "üì¶ UPDATE GITOPS REPO"
              echo "##################################################"
              echo ""
              echo "  Model ........ ${MODEL_NAME}"
              echo "  URI .......... ${MODEL_URI}"
              echo "  Image ........ ${SERVING_IMAGE}"
              echo ""
              echo "--------------------------------------------------"
              echo "‚ùå FAILED - Service file not found"
              echo "   ${SERVICE_FILE}"
              echo "--------------------------------------------------"
              echo ""
              echo "##################################################"
              echo ""
            } | tee /tmp/deployment-report.md
            exit 1
          fi

          # ===============================================================
          # UPDATE IMAGE TAG
          # ===============================================================
          sed -i "s|image: opencloudhuborg/${MODEL_NAME}-serving:[a-zA-Z0-9_.-]*|image: ${SERVING_IMAGE}|g" "$SERVICE_FILE"

          # ===============================================================
          # UPDATE MODEL_URI IN USER_CONFIG
          # ===============================================================
          # Three cases:
          #   1. user_config + model_uri exist ‚Üí update model_uri
          #   2. user_config exists, no model_uri ‚Üí add model_uri line
          #   3. no user_config ‚Üí add user_config block after deployment name

          if grep -q "user_config:" "$SERVICE_FILE"; then
            if grep -q "model_uri:" "$SERVICE_FILE"; then
              # Case 1: Update existing model_uri
              sed -i "s|model_uri: \"models:/[^\"]*\"|model_uri: \"${MODEL_URI}\"|g" "$SERVICE_FILE"
            else
              # Case 2: Add model_uri after user_config line
              sed -i "/user_config:/a\\              model_uri: \"${MODEL_URI}\"" "$SERVICE_FILE"
            fi
          else
            # Case 3: Add user_config block after first deployment's "- name:" line
            awk -v model_uri="${MODEL_URI}" '
              /deployments:/ { in_deployments = 1 }
              in_deployments && /^[[:space:]]*- name:/ && !added {
                print
                print "            user_config:"
                print "              model_uri: \"" model_uri "\""
                added = 1
                next
              }
              { print }
            ' "$SERVICE_FILE" > "${SERVICE_FILE}.tmp" && mv "${SERVICE_FILE}.tmp" "$SERVICE_FILE"
          fi

          # ===============================================================
          # COMMIT AND PUSH
          # ===============================================================
          git config user.name "Argo Workflow"
          git config user.email "workflow@opencloudhub.org"
          git add "$SERVICE_FILE"

          if git diff --cached --quiet; then
            STATUS="‚è∏Ô∏è  NO CHANGES - Already up to date"
          else
            git commit -m "deploy(${MODEL_NAME}): v${VERSION} - ${SERVING_IMAGE##*:}"
            git push
            STATUS="‚úÖ GITOPS UPDATED - Pushed: deploy(${MODEL_NAME}) v${VERSION}"
          fi

          # ===============================================================
          # REPORT
          # ===============================================================
          {
            echo ""
            echo "##################################################"
            echo "üì¶ UPDATE GITOPS REPO"
            echo "##################################################"
            echo ""
            echo "  Model ........ ${MODEL_NAME}"
            echo "  URI .......... ${MODEL_URI}"
            echo "  Image ........ ${SERVING_IMAGE}"
            echo "  File ......... ${SERVICE_FILE}"
            echo ""
            echo "--------------------------------------------------"
            echo "${STATUS}"
            echo "--------------------------------------------------"
            echo ""
            echo "##################################################"
            echo ""
          } | tee /tmp/deployment-report.md

# =============================================================================
# MLOps Pipeline (Simplified)
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: mlops-pipeline
  namespace: mlops
spec:
  serviceAccountName: workflow-executor
  entrypoint: main

  arguments:
    parameters:
      # Model identity
      - name: model_name
      - name: experiment_name

      # Images
      - name: training_image
      - name: serving_image
      - name: training_entrypoint
      - name: training_args
        default: ""

      # Data
      - name: dvc_data_version

      # Compute (direct values, no mapping needed for simplicity)
      - name: cpu
        default: "2"
      - name: memory
        default: "4Gi"
      - name: gpu
        default: "0"
      - name: workers
        default: "1"

      # Comparison
      - name: comparison_metric
        default: "accuracy"
      - name: comparison_higher_is_better
        default: "true"
      - name: comparison_threshold
        default: "0.05"

      # Approval
      - name: approval_mode
        default: "automatic"

  templates:
    - name: main
      steps:
        # Phase 1: Training
        - - name: train
            templateRef:
              name: ray-templates
              template: training-job
            arguments:
              parameters:
                - name: job_prefix
                  value: "{{workflow.parameters.model_name}}-train"
                - name: image
                  value: "{{workflow.parameters.training_image}}"
                - name: entrypoint
                  value: "{{workflow.parameters.training_entrypoint}} {{workflow.parameters.training_args}}"
                - name: model_configmap
                  value: "{{workflow.parameters.model_name}}-env"
                - name: cpu
                  value: "{{workflow.parameters.cpu}}"
                - name: memory
                  value: "{{workflow.parameters.memory}}"
                - name: gpu
                  value: "{{workflow.parameters.gpu}}"
                - name: workers
                  value: "{{workflow.parameters.workers}}"
                - name: dvc_data_version
                  value: "{{workflow.parameters.dvc_data_version}}"
                - name: num_workers
                  value: "{{workflow.parameters.workers}}"

        # Phase 2: Compare and promote to staging
        - - name: compare-and-promote
            templateRef:
              name: mlflow-templates
              template: compare-to-production-and-promote-to-staging
            arguments:
              parameters:
                - name: model_name
                  value: "{{workflow.parameters.model_name}}"
                - name: metric_name
                  value: "{{workflow.parameters.comparison_metric}}"
                - name: higher_is_better
                  value: "{{workflow.parameters.comparison_higher_is_better}}"
                - name: threshold
                  value: "{{workflow.parameters.comparison_threshold}}"

        # Phase 3: Approval gate (manual mode only)
        - - name: approval
            template: approval-gate
            when: "'{{workflow.parameters.approval_mode}}' == 'manual' && '{{steps.compare-and-promote.outputs.parameters.promoted}}' == 'true'"

        # Phase 4: Promote to production
        - - name: promote-production
            templateRef:
              name: mlflow-templates
              template: promote-staging-to-production
            arguments:
              parameters:
                - name: model_name
                  value: "{{workflow.parameters.model_name}}"
                - name: staging_version
                  value: "{{steps.compare-and-promote.outputs.parameters.staging_version}}"
            when: "'{{steps.compare-and-promote.outputs.parameters.promoted}}' == 'true'"

        # Phase 5: Deploy
        - - name: deploy
            templateRef:
              name: deployment-templates
              template: deploy-model
            arguments:
              parameters:
                - name: model_name
                  value: "{{workflow.parameters.model_name}}"
                - name: model_uri
                  value: "models:/prod.{{workflow.parameters.model_name}}/@champion"
                - name: serving_image
                  value: "{{workflow.parameters.serving_image}}"
            when: "'{{steps.compare-and-promote.outputs.parameters.promoted}}' == 'true'"

    # =========================================================================
    # APPROVAL GATE
    # =========================================================================
    - name: approval-gate
      inputs:
        parameters:
          - name: approve
            default: "NO"
            enum: ["YES", "NO"]
      outputs:
        parameters:
          - name: approve
            valueFrom:
              supplied: {}
      suspend: {}

apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: data-pipeline
  namespace: mlops
  annotations:
    workflows.argoproj.io/title: '**Data Pipeline Example**'
    workflows.argoproj.io/description: "Run DVC data pipelines with automatic versioning"
spec:
  serviceAccountName: workflow-executor

  arguments:
    parameters:
      - name: pipelines
        description: "JSON array of pipeline names to run"
        value: '["opencloudhub-readmes-download"]'
      - name: force
        description: "Force re-run even if no changes"
        value: "false"
      - name: bump_type
        description: "Version bump type: major, minor, patch"
        value: "patch"
      - name: is_automated
        description: "Add -automated suffix to tags"
        value: "false"
      - name: compute_type
        description: "Compute profile: cpu-small, cpu-medium, cpu-large, gpu-small, etc."
        value: "cpu-small"
      - name: image
        description: "Docker image for DVC operations"
        value: "opencloudhuborg/data-registry-pipelines:latest"

  entrypoint: main

  templates:
    # --------------------------------------------------------------------------
    # Main: fan out to run each pipeline in parallel
    # --------------------------------------------------------------------------
    - name: main
      steps:
        - - name: run-pipeline
            template: single-pipeline
            arguments:
              parameters:
                - name: pipeline_name
                  value: "{{item}}"
            withParam: "{{workflow.parameters.pipelines}}"

    # --------------------------------------------------------------------------
    # Single pipeline: clone -> run -> push -> commit -> tag
    # --------------------------------------------------------------------------
    - name: single-pipeline
      inputs:
        parameters:
          - name: pipeline_name
      outputs:
        parameters:
          - name: tag
            valueFrom:
              parameter: "{{steps.create-tag.outputs.parameters.new_tag}}"
          - name: changed
            valueFrom:
              parameter: "{{steps.run-dvc.outputs.parameters.changed}}"
      steps:
        # Step 1: Clone repository
        - - name: clone
            templateRef:
              name: git-templates
              template: clone-repo
            arguments:
              parameters:
                - name: clone_path
                  value: "/tmp/repo-{{inputs.parameters.pipeline_name}}"

        # Step 2: Map compute type to resources
        - - name: map-compute
            templateRef:
              name: compute-templates
              template: map-compute-config
            arguments:
              parameters:
                - name: compute_type
                  value: "{{workflow.parameters.compute_type}}"

        # Step 3: Run DVC pipeline
        - - name: run-dvc
            templateRef:
              name: data-templates
              template: run-dvc-pipeline
            arguments:
              parameters:
                - name: repo_path
                  value: "/tmp/repo-{{inputs.parameters.pipeline_name}}"
                - name: pipeline_name
                  value: "{{inputs.parameters.pipeline_name}}"
                - name: force
                  value: "{{workflow.parameters.force}}"
                - name: image
                  value: "{{workflow.parameters.image}}"
                - name: cpu_request
                  value: "{{steps.map-compute.outputs.parameters.cpu_request}}"
                - name: cpu_limit
                  value: "{{steps.map-compute.outputs.parameters.cpu_limit}}"
                - name: memory_request
                  value: "{{steps.map-compute.outputs.parameters.memory_request}}"
                - name: memory_limit
                  value: "{{steps.map-compute.outputs.parameters.memory_limit}}"
              artifacts:
                - name: repo
                  from: "{{steps.clone.outputs.artifacts.repo}}"

        # Step 4: Push to DVC remote
        - - name: dvc-push
            templateRef:
              name: data-templates
              template: dvc-push
            arguments:
              parameters:
                - name: repo_path
                  value: "/tmp/repo-{{inputs.parameters.pipeline_name}}"
                - name: image
                  value: "{{workflow.parameters.image}}"
              artifacts:
                - name: repo
                  from: "{{steps.run-dvc.outputs.artifacts.repo}}"

        # Step 5: Commit changes (only if changed)
        - - name: commit
            templateRef:
              name: git-templates
              template: commit-and-push
            arguments:
              parameters:
                - name: repo_path
                  value: "/tmp/repo-{{inputs.parameters.pipeline_name}}"
                - name: files_to_add
                  value: "pipelines/{{inputs.parameters.pipeline_name}}/"
                - name: commit_message
                  value: "chore({{inputs.parameters.pipeline_name}}): update dvc.lock [skip ci]"
              artifacts:
                - name: repo
                  from: "{{steps.dvc-push.outputs.artifacts.repo}}"
            when: "{{steps.run-dvc.outputs.parameters.changed}} == true"

        # Step 6: Create version tag (only if changed)
        - - name: create-tag
            templateRef:
              name: git-templates
              template: create-tag
            arguments:
              parameters:
                - name: repo_path
                  value: "/tmp/repo-{{inputs.parameters.pipeline_name}}"
                - name: tag_prefix
                  value: "{{inputs.parameters.pipeline_name}}"
                - name: bump_type
                  value: "{{workflow.parameters.bump_type}}"
                - name: is_automated
                  value: "{{workflow.parameters.is_automated}}"
              artifacts:
                - name: repo
                  from: "{{steps.commit.outputs.artifacts.repo}}"
            when: "{{steps.run-dvc.outputs.parameters.changed}} == true"

        # Step 7: Summary
        - - name: summary
            template: pipeline-summary
            arguments:
              parameters:
                - name: pipeline_name
                  value: "{{inputs.parameters.pipeline_name}}"
                - name: changed
                  value: "{{steps.run-dvc.outputs.parameters.changed}}"
                - name: tag
                  value: "{{steps.create-tag.outputs.parameters.new_tag}}"

    # --------------------------------------------------------------------------
    # Summary output
    # --------------------------------------------------------------------------
    - name: pipeline-summary
      inputs:
        parameters:
          - name: pipeline_name
          - name: changed
          - name: tag
      script:
        image: alpine:latest
        command: [sh]
        source: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Pipeline Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Pipeline: {{inputs.parameters.pipeline_name}}"
          echo "Changed:  {{inputs.parameters.changed}}"
          echo "Tag:      {{inputs.parameters.tag}}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: data-pipeline
  namespace: mlops
spec:
  serviceAccountName: workflow-executor

  arguments:
    parameters:
      - name: pipelines
        value: '["opencloudhub-readmes-download"]'
      - name: force
        value: "false"
      - name: bump_type
        value: "patch"
      - name: is_automated
        value: "false"
      - name: trigger_embeddings
        value: "true"
      - name: image
        value: "opencloudhuborg/data-registry-pipelines:latest"

  entrypoint: main

  templates:
    - name: main
      steps:
        - - name: run-pipeline
            template: run-pipeline
            arguments:
              parameters:
                - name: pipeline_name
                  value: "{{item}}"
            withParam: "{{workflow.parameters.pipelines}}"

        - - name: trigger-embeddings
            template: trigger-embeddings
            arguments:
              parameters:
                - name: results
                  value: "{{steps.run-pipeline.outputs.parameters}}"
            when: "{{workflow.parameters.trigger_embeddings}} == true"

    # --------------------------------------------------------------------------
    # Single pipeline: clone, run, push, commit, tag - fully self-contained
    # --------------------------------------------------------------------------
    - name: run-pipeline
      inputs:
        parameters:
          - name: pipeline_name
      outputs:
        parameters:
          - name: dataset
            valueFrom:
              path: /tmp/outputs/dataset.txt
          - name: tag
            valueFrom:
              path: /tmp/outputs/tag.txt
          - name: changed
            valueFrom:
              path: /tmp/outputs/changed.txt
      volumes:
        - name: git-secret
          secret:
            secretName: data-registry-repo
      container:
        image: "{{workflow.parameters.image}}"
        command: [bash, -c]
        args:
          - |
            set -e

            PIPELINE="{{inputs.parameters.pipeline_name}}"
            FORCE="{{workflow.parameters.force}}"
            BUMP_TYPE="{{workflow.parameters.bump_type}}"
            IS_AUTOMATED="{{workflow.parameters.is_automated}}"

            # Map pipeline -> dataset
            case "$PIPELINE" in
              opencloudhub-readmes-download) DATASET="opencloudhub-readmes" ;;
              *) DATASET="$PIPELINE" ;;
            esac

            # Initialize outputs
            mkdir -p /tmp/outputs
            echo "$DATASET" > /tmp/outputs/dataset.txt
            echo "" > /tmp/outputs/tag.txt
            echo "false" > /tmp/outputs/changed.txt

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸš€ Pipeline: $PIPELINE â†’ Dataset: $DATASET"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            # Setup SSH
            mkdir -p ~/.ssh
            cat /mnt/secrets/sshPrivateKey > ~/.ssh/id_ed25519
            echo "" >> ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null

            # Clone
            echo "ğŸ“¥ Cloning..."
            git clone git@github.com:OpenCloudHub/data-registry.git /tmp/repo
            cd /tmp/repo
            git config user.name "Argo Workflow"
            git config user.email "workflow@opencloudhub.org"

            # Configure DVC
            dvc remote modify minio endpointurl "$AWS_ENDPOINT_URL"
            dvc remote modify minio access_key_id "$AWS_ACCESS_KEY_ID"
            dvc remote modify minio secret_access_key "$AWS_SECRET_ACCESS_KEY"

            # Hash before
            LOCK_FILE="pipelines/${PIPELINE}/dvc.lock"
            HASH_BEFORE="none"
            [ -f "$LOCK_FILE" ] && HASH_BEFORE=$(md5sum "$LOCK_FILE" | cut -d' ' -f1)

            # Run DVC
            echo "ğŸ”„ Running DVC..."
            FORCE_FLAG=""
            [ "$FORCE" = "true" ] && FORCE_FLAG="--force" && echo "âš ï¸ Force mode"
            dvc repro $FORCE_FLAG "pipelines/${PIPELINE}/dvc.yaml"

            # Push data
            echo "ğŸ“¤ Pushing data..."
            dvc push

            # Check if changed
            HASH_AFTER="none"
            [ -f "$LOCK_FILE" ] && HASH_AFTER=$(md5sum "$LOCK_FILE" | cut -d' ' -f1)

            if [ "$HASH_BEFORE" = "$HASH_AFTER" ]; then
              echo "âœ… No changes"
              exit 0
            fi

            echo "true" > /tmp/outputs/changed.txt
            echo "ğŸ“ dvc.lock changed"

            # Commit with retry
            git add "pipelines/${PIPELINE}/"
            git commit -m "chore(${DATASET}): update dvc.lock [skip ci]"

            for attempt in 1 2 3; do
              echo "ğŸ”„ Push attempt $attempt..."
              if git push origin main; then
                echo "âœ… Pushed"
                break
              fi
              if [ $attempt -eq 3 ]; then
                echo "âŒ Failed after 3 attempts"
                exit 1
              fi
              echo "âš ï¸ Conflict, rebasing..."
              git pull --rebase origin main
            done

            # Create tag
            [ "$IS_AUTOMATED" = "true" ] && SUFFIX="-automated" || SUFFIX=""

            LATEST=$(git tag -l "${DATASET}-v*" --sort=-version:refname | head -n1 || echo "")
            if [ -z "$LATEST" ]; then
              VERSION="1.0.0"
            else
              CURRENT=$(echo "$LATEST" | sed "s/${DATASET}-v//" | sed 's/-automated//')
              MAJOR=$(echo "$CURRENT" | cut -d. -f1)
              MINOR=$(echo "$CURRENT" | cut -d. -f2)
              PATCH=$(echo "$CURRENT" | cut -d. -f3)
              case "$BUMP_TYPE" in
                major) VERSION="$((MAJOR + 1)).0.0" ;;
                minor) VERSION="${MAJOR}.$((MINOR + 1)).0" ;;
                *) VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))" ;;
              esac
            fi

            NEW_TAG="${DATASET}-v${VERSION}${SUFFIX}"

            if git tag -l "$NEW_TAG" | grep -q .; then
              echo "â„¹ï¸ Tag $NEW_TAG exists"
              echo "$NEW_TAG" > /tmp/outputs/tag.txt
            else
              git tag -a "$NEW_TAG" -m "${DATASET} v${VERSION}"
              git push origin "$NEW_TAG"
              echo "ğŸ·ï¸ Created: $NEW_TAG"
              echo "$NEW_TAG" > /tmp/outputs/tag.txt
            fi

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… Complete: $NEW_TAG"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        volumeMounts:
          - name: git-secret
            mountPath: /mnt/secrets
            readOnly: true
        env:
          - name: AWS_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: minio-tenant-secret
                key: accesskey
          - name: AWS_SECRET_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: minio-tenant-secret
                key: secretkey
          - name: AWS_ENDPOINT_URL
            value: "https://minio-api.internal.opencloudhub.org"
        resources:
          requests:
            cpu: "500m"
            memory: "1Gi"
          limits:
            cpu: "2"
            memory: "4Gi"

    # --------------------------------------------------------------------------
    # Trigger embeddings if opencloudhub-readmes changed
    # --------------------------------------------------------------------------
    - name: trigger-embeddings
      inputs:
        parameters:
          - name: results
      steps:
        - - name: extract-tag
            template: extract-readmes-tag
            arguments:
              parameters:
                - name: results
                  value: "{{inputs.parameters.results}}"
        - - name: run-embeddings
            templateRef:
              name: embeddings-pipeline
              template: main
            arguments:
              parameters:
                - name: data_version
                  value: "{{steps.extract-tag.outputs.parameters.tag}}"
                - name: compute_type
                  value: "cpu-medium"
                - name: image
                  value: "{{workflow.parameters.image}}"
            when: "'{{steps.extract-tag.outputs.parameters.tag}}' != ''"

    - name: extract-readmes-tag
      inputs:
        parameters:
          - name: results
      outputs:
        parameters:
          - name: tag
            valueFrom:
              path: /tmp/tag.txt
      script:
        image: alpine:latest
        command: [sh]
        source: |
          apk add --no-cache jq >/dev/null 2>&1
          echo "" > /tmp/tag.txt

          RESULTS='{{inputs.parameters.results}}'
          TAG=$(echo "$RESULTS" | jq -r '.[] | select(.dataset == "opencloudhub-readmes" and .changed == "true") | .tag' 2>/dev/null | head -1 || echo "")

          if [ -n "$TAG" ] && [ "$TAG" != "null" ]; then
            echo "$TAG" > /tmp/tag.txt
            echo "ğŸ¯ Found: $TAG"
          else
            echo "â„¹ï¸ No readmes changes"
          fi

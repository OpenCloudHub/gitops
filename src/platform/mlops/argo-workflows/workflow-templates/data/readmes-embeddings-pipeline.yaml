apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: embeddings-pipeline
  namespace: mlops
spec:
  serviceAccountName: workflow-executor

  arguments:
    parameters:
      - name: data_version
      - name: force
        value: "false"
      - name: compute_type
        value: "cpu-medium"
      - name: image
        value: "opencloudhuborg/data-registry-pipelines:latest"
      - name: bump_type
        value: "patch"
      - name: is_automated
        value: "false"

  entrypoint: main

  templates:
    - name: main
      steps:
        - - name: map-compute
            templateRef:
              name: compute-templates
              template: map-compute-config
            arguments:
              parameters:
                - name: compute_type
                  value: "{{workflow.parameters.compute_type}}"

        - - name: run-embeddings
            template: submit-ray-embeddings
            arguments:
              parameters:
                - name: data_version
                  value: "{{workflow.parameters.data_version}}"
                - name: force
                  value: "{{workflow.parameters.force}}"
                - name: image
                  value: "{{workflow.parameters.image}}"
                - name: cpu_request
                  value: "{{steps.map-compute.outputs.parameters.cpu_request}}"
                - name: cpu_limit
                  value: "{{steps.map-compute.outputs.parameters.cpu_limit}}"
                - name: memory_request
                  value: "{{steps.map-compute.outputs.parameters.memory_request}}"
                - name: memory_limit
                  value: "{{steps.map-compute.outputs.parameters.memory_limit}}"
                - name: replicas
                  value: "{{steps.map-compute.outputs.parameters.replicas}}"

        - - name: commit-and-tag
            template: git-commit-tag
            when: "{{steps.run-embeddings.exitCode}} == 0"
            arguments:
              parameters:
                - name: data_version
                  value: "{{workflow.parameters.data_version}}"
                - name: bump_type
                  value: "{{workflow.parameters.bump_type}}"
                - name: is_automated
                  value: "{{workflow.parameters.is_automated}}"

    - name: submit-ray-embeddings
      inputs:
        parameters:
          - name: data_version
          - name: force
          - name: image
          - name: cpu_request
          - name: cpu_limit
          - name: memory_request
          - name: memory_limit
          - name: replicas
      outputs:
        parameters:
          - name: job-name
            valueFrom:
              path: /tmp/job-name.txt
      script:
        image: bitnami/kubectl:latest
        command: [bash]
        source: |
          set -e

          DATA_VERSION="{{inputs.parameters.data_version}}"
          FORCE="{{inputs.parameters.force}}"
          IMAGE="{{inputs.parameters.image}}"
          CPU_REQUEST="{{inputs.parameters.cpu_request}}"
          CPU_LIMIT="{{inputs.parameters.cpu_limit}}"
          MEMORY_REQUEST="{{inputs.parameters.memory_request}}"
          MEMORY_LIMIT="{{inputs.parameters.memory_limit}}"
          REPLICAS="{{inputs.parameters.replicas}}"
          RUN_LABEL="emb$(date +%Y%m%d%H%M%S)"

          FORCE_FLAG=""
          [ "$FORCE" = "true" ] && FORCE_FLAG="--force"

          echo "Creating RayJob: ${RUN_LABEL}"
          echo "Data version: ${DATA_VERSION}"
          echo "Image: ${IMAGE}"

          ENTRYPOINT="sed -i s/version:.*/version:${DATA_VERSION}/ pipelines/opencloudhub-readmes-embeddings/params.yaml && dvc repro ${FORCE_FLAG} pipelines/opencloudhub-readmes-embeddings/dvc.yaml"

          kubectl create -f - <<YAML
          apiVersion: ray.io/v1
          kind: RayJob
          metadata:
            generateName: embeddings-
            namespace: mlops
            labels:
              run: "$RUN_LABEL"
          spec:
            entrypoint: "$ENTRYPOINT"
            runtimeEnvYAML: "working_dir: /workspace/project"
            shutdownAfterJobFinishes: true
            ttlSecondsAfterFinished: 300
            rayClusterSpec:
              rayVersion: "2.48.0"
              headGroupSpec:
                serviceType: ClusterIP
                template:
                  spec:
                    containers:
                    - name: ray-head
                      image: "$IMAGE"
                      resources:
                        requests:
                          cpu: "$CPU_REQUEST"
                          memory: "$MEMORY_REQUEST"
                        limits:
                          cpu: "$CPU_LIMIT"
                          memory: "$MEMORY_LIMIT"
                      env:
                      - name: AWS_ACCESS_KEY_ID
                        valueFrom:
                          secretKeyRef:
                            name: minio-tenant-secret
                            key: accesskey
                      - name: AWS_SECRET_ACCESS_KEY
                        valueFrom:
                          secretKeyRef:
                            name: minio-tenant-secret
                            key: secretkey
                      - name: AWS_ENDPOINT_URL
                        valueFrom:
                          secretKeyRef:
                            name: minio-tenant-secret
                            key: endpoint-url
                      - name: PGVECTOR_HOST
                        value: "cnpg-cluster-rw.storage.svc.cluster.local"
                      - name: POSTGRES_DEMO_APP_DB_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: demo-app-db-user
                            key: password
                      - name: DVC_REPO
                        value: "https://github.com/OpenCloudHub/data-registry"
              workerGroupSpecs:
              - replicas: $REPLICAS
                groupName: worker
                template:
                  spec:
                    containers:
                    - name: ray-worker
                      image: "$IMAGE"
                      resources:
                        requests:
                          cpu: "$CPU_REQUEST"
                          memory: "$MEMORY_REQUEST"
                        limits:
                          cpu: "$CPU_LIMIT"
                          memory: "$MEMORY_LIMIT"
                      env:
                      - name: AWS_ACCESS_KEY_ID
                        valueFrom:
                          secretKeyRef:
                            name: minio-tenant-secret
                            key: accesskey
                      - name: AWS_SECRET_ACCESS_KEY
                        valueFrom:
                          secretKeyRef:
                            name: minio-tenant-secret
                            key: secretkey
                      - name: AWS_ENDPOINT_URL
                        valueFrom:
                          secretKeyRef:
                            name: minio-tenant-secret
                            key: endpoint-url
                      - name: PGVECTOR_HOST
                        value: "cnpg-cluster-rw.storage.svc.cluster.local"
                      - name: POSTGRES_DEMO_APP_DB_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: demo-app-db-user
                            key: password
                      - name: DVC_REPO
                        value: "https://github.com/OpenCloudHub/data-registry"
          YAML

          sleep 3
          JOB_NAME=$(kubectl get rayjobs -n mlops -l run=${RUN_LABEL} -o jsonpath='{.items[0].metadata.name}')

          if [ -z "$JOB_NAME" ]; then
            echo "Failed to get RayJob"
            exit 1
          fi

          echo "RayJob: $JOB_NAME"
          echo "$JOB_NAME" > /tmp/job-name.txt

          echo "Waiting for job to start..."
          for i in $(seq 1 240); do
            STATUS=$(kubectl get rayjob -n mlops $JOB_NAME -o jsonpath='{.status.jobDeploymentStatus}' 2>/dev/null || echo "")
            if [ "$STATUS" = "Running" ] || [ "$STATUS" = "Complete" ]; then
              echo "Job running"
              break
            fi
            if [ "$STATUS" = "Failed" ]; then
              echo "Job deployment failed"
              kubectl describe rayjob -n mlops $JOB_NAME
              exit 1
            fi
            sleep 5
          done

          sleep 5
          SUBMITTER=$(kubectl get pods -n mlops 2>/dev/null | grep "${JOB_NAME}" | grep -v head | grep -v worker | awk '{print $1}' | head -1)

          if [ -n "$SUBMITTER" ]; then
            echo "Streaming logs from: $SUBMITTER"
            kubectl logs -n mlops $SUBMITTER -f 2>/dev/null &
            LOGPID=$!
          fi

          while true; do
            JOBSTATUS=$(kubectl get rayjob -n mlops $JOB_NAME -o jsonpath='{.status.jobStatus}' 2>/dev/null || echo "")

            case "$JOBSTATUS" in
              SUCCEEDED)
                sleep 2
                [ -n "$LOGPID" ] && kill $LOGPID 2>/dev/null || true
                echo "SUCCESS"
                exit 0
                ;;
              FAILED|STOPPED)
                [ -n "$LOGPID" ] && kill $LOGPID 2>/dev/null || true
                echo "FAILED: $JOBSTATUS"
                kubectl describe rayjob -n mlops $JOB_NAME
                exit 1
                ;;
            esac
            sleep 5
          done

    - name: git-commit-tag
      inputs:
        parameters:
          - name: data_version
          - name: bump_type
          - name: is_automated
      outputs:
        parameters:
          - name: tag
            valueFrom:
              path: /tmp/tag.txt
      volumes:
        - name: git-secret
          secret:
            secretName: data-registry-repo
      script:
        image: alpine/git:latest
        command: [sh]
        volumeMounts:
          - name: git-secret
            mountPath: /mnt/secrets
            readOnly: true
        source: |
          set -e
          echo "" > /tmp/tag.txt

          DATA_VERSION="{{inputs.parameters.data_version}}"
          BUMP_TYPE="{{inputs.parameters.bump_type}}"
          IS_AUTOMATED="{{inputs.parameters.is_automated}}"
          TAG_PREFIX="opencloudhub-readmes-embeddings"

          mkdir -p ~/.ssh
          cat /mnt/secrets/sshPrivateKey > ~/.ssh/id_ed25519
          echo "" >> ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null

          git clone git@github.com:OpenCloudHub/data-registry.git /tmp/repo
          cd /tmp/repo
          git config user.name "Argo Workflow"
          git config user.email "workflow@opencloudhub.org"

          [ "$IS_AUTOMATED" = "true" ] && SUFFIX="-automated" || SUFFIX=""

          LATEST=$(git tag -l "${TAG_PREFIX}-v*" --sort=-version:refname | head -n1)
          if [ -z "$LATEST" ]; then
            VERSION="1.0.0"
          else
            CURRENT=$(echo "$LATEST" | sed "s/${TAG_PREFIX}-v//" | sed 's/-automated//')
            MAJOR=$(echo "$CURRENT" | cut -d. -f1)
            MINOR=$(echo "$CURRENT" | cut -d. -f2)
            PATCH=$(echo "$CURRENT" | cut -d. -f3)
            case "$BUMP_TYPE" in
              major) VERSION="$((MAJOR + 1)).0.0" ;;
              minor) VERSION="${MAJOR}.$((MINOR + 1)).0" ;;
              *) VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))" ;;
            esac
          fi

          NEW_TAG="${TAG_PREFIX}-v${VERSION}${SUFFIX}"

          if git tag -l "$NEW_TAG" | grep -q .; then
            echo "Tag $NEW_TAG exists"
          else
            git tag -a "$NEW_TAG" -m "Embeddings v${VERSION} (source: ${DATA_VERSION})"
            git push origin "$NEW_TAG"
            echo "Created: $NEW_TAG"
          fi

          echo "$NEW_TAG" > /tmp/tag.txt

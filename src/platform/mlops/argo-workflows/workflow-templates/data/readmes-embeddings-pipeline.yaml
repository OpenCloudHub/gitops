apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: embeddings-pipeline
  namespace: mlops
  annotations:
    description: "Generate embeddings from downloaded data and store in pgvector"
spec:
  serviceAccountName: workflow-executor

  arguments:
    parameters:
      - name: data_version
        description: "Source data version tag (e.g., opencloudhub-readmes-download-v1.0.0)"
      - name: force
        value: "false"
        description: "Force re-run even if DVC cache exists"
      - name: compute_type
        value: "cpu-medium"
        enum: [cpu-small, cpu-medium, cpu-large, gpu-small, gpu-medium, gpu-large]
        description: "Compute configuration for Ray cluster"
      - name: image
        value: "opencloudhuborg/data-registry-pipelines:latest"
        description: "Docker image for embeddings pipeline"
      - name: bump_type
        value: "patch"
        enum: [major, minor, patch]
        description: "Version bump type for output tag"
      - name: is_automated
        value: "false"
        description: "Add -automated suffix to output tag"

  entrypoint: main

  templates:
    - name: main
      steps:
        # Step 1: Map compute type to resource specs
        - - name: map-compute
            templateRef:
              name: compute-templates
              template: map-compute-config
            arguments:
              parameters:
                - name: compute_type
                  value: "{{workflow.parameters.compute_type}}"

        # Step 2: Prepare parameters using Python (safe string handling)
        - - name: prepare-params
            template: prepare-params-python
            arguments:
              parameters:
                - name: data_version
                  value: "{{workflow.parameters.data_version}}"
                - name: force
                  value: "{{workflow.parameters.force}}"

        # Step 3: Create RayJob using Argo resource template
        - - name: create-rayjob
            templateRef:
              name: ray-templates
              template: create-rayjob-resource
            arguments:
              parameters:
                - name: run_label
                  value: "{{steps.prepare-params.outputs.parameters.run_label}}"
                - name: entrypoint
                  value: "{{steps.prepare-params.outputs.parameters.entrypoint}}"
                - name: image
                  value: "{{workflow.parameters.image}}"
                - name: cpu_request
                  value: "{{steps.map-compute.outputs.parameters.cpu_request}}"
                - name: cpu_limit
                  value: "{{steps.map-compute.outputs.parameters.cpu_limit}}"
                - name: memory_request
                  value: "{{steps.map-compute.outputs.parameters.memory_request}}"
                - name: memory_limit
                  value: "{{steps.map-compute.outputs.parameters.memory_limit}}"
                - name: replicas
                  value: "{{steps.map-compute.outputs.parameters.replicas}}"

        # Step 4: Wait for job completion
        - - name: wait-for-rayjob
            templateRef:
              name: ray-templates
              template: wait-for-rayjob
            arguments:
              parameters:
                - name: job_name
                  value: "{{steps.create-rayjob.outputs.parameters.job_name}}"
                - name: timeout_seconds
                  value: "3600"

        # Step 5: Tag the successful run
        - - name: git-tag
            templateRef:
              name: git-templates
              template: git-tag-version
            when: "{{steps.wait-for-rayjob.outputs.parameters.job_status}} == SUCCEEDED"
            arguments:
              parameters:
                - name: tag_prefix
                  value: "opencloudhub-readmes-embeddings"
                - name: bump_type
                  value: "{{workflow.parameters.bump_type}}"
                - name: is_automated
                  value: "{{workflow.parameters.is_automated}}"
                - name: message
                  value: "Embeddings generated from {{workflow.parameters.data_version}}"

    # ==========================================================================
    # PREPARE PARAMS WITH PYTHON (safe string building)
    # ==========================================================================
    - name: prepare-params-python
      inputs:
        parameters:
          - name: data_version
          - name: force
      outputs:
        parameters:
          - name: run_label
            valueFrom:
              path: /tmp/run_label.txt
          - name: entrypoint
            valueFrom:
              path: /tmp/entrypoint.txt
      script:
        image: python:3.12-alpine
        command: [python]
        source: |
          import datetime

          data_version = """{{inputs.parameters.data_version}}""".strip()
          force = """{{inputs.parameters.force}}""".strip().lower() == "true"

          # Generate unique run label
          run_label = f"emb{datetime.datetime.now().strftime('%Y%m%d%H%M%S')}"
          
          # Build entrypoint - Python handles quoting correctly
          force_flag = "--force " if force else ""
          entrypoint = (
              f"cd /workspace/project && "
              f"sed -i 's/DATA_VERSION = .*/DATA_VERSION = \"{data_version}\"/' "
              f"pipelines/opencloudhub-readmes-embeddings/params.py && "
              f"/workspace/project/.venv/bin/dvc repro {force_flag}"
              f"pipelines/opencloudhub-readmes-embeddings/dvc.yaml"
          )
          
          # Write outputs
          with open("/tmp/run_label.txt", "w") as f:
              f.write(run_label)
          
          with open("/tmp/entrypoint.txt", "w") as f:
              f.write(entrypoint)
          
          print(f"Run Label: {run_label}")
          print(f"Data Version: {data_version}")
          print(f"Force: {force}")
          print(f"Entrypoint: {entrypoint}")
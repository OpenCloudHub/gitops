apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: embeddings-pipeline
  namespace: mlops
spec:
  serviceAccountName: workflow-executor
  arguments:
    parameters:
      - name: data_version
      - name: force
        value: "false"
      - name: compute_type
        value: "cpu-medium"
      - name: image
        value: "opencloudhuborg/data-registry-pipelines:latest"
      - name: bump_type
        value: "patch"
      - name: is_automated
        value: "false"

  entrypoint: main

  templates:
    - name: main
      steps:
        - - name: map-compute
            templateRef:
              name: compute-templates
              template: map-compute-config
            arguments:
              parameters:
                - name: compute_type
                  value: "{{workflow.parameters.compute_type}}"

        - - name: generate-run-label
            template: generate-label

        - - name: create-rayjob
            templateRef:
              name: ray-templates
              template: create-rayjob-resource
            arguments:
              parameters:
                - name: run_label
                  value: "{{steps.generate-run-label.outputs.result}}"
                - name: data_version
                  value: "{{workflow.parameters.data_version}}"
                - name: force
                  value: "{{workflow.parameters.force}}"
                - name: image
                  value: "{{workflow.parameters.image}}"
                - name: cpu_request
                  value: "{{steps.map-compute.outputs.parameters.cpu_request}}"
                - name: cpu_limit
                  value: "{{steps.map-compute.outputs.parameters.cpu_limit}}"
                - name: memory_request
                  value: "{{steps.map-compute.outputs.parameters.memory_request}}"
                - name: memory_limit
                  value: "{{steps.map-compute.outputs.parameters.memory_limit}}"
                - name: replicas
                  value: "{{steps.map-compute.outputs.parameters.replicas}}"

        - - name: wait-for-rayjob
            templateRef:
              name: ray-templates
              template: wait-for-rayjob
            arguments:
              parameters:
                - name: job_name
                  value: "{{steps.create-rayjob.outputs.parameters.job_name}}"

        # TODO: we need to check if something changed in dvc

        - - name: git-tag
            templateRef:
              name: git-templates
              template: git-tag-version
            when: "{{steps.wait-for-rayjob.outputs.parameters.job_status}} == SUCCEEDED"
            arguments:
              parameters:
                - name: tag_prefix
                  value: "opencloudhub-readmes-embeddings"
                - name: bump_type
                  value: "{{workflow.parameters.bump_type}}"
                - name: is_automated
                  value: "{{workflow.parameters.is_automated}}"
                - name: message
                  value: "Embeddings from {{workflow.parameters.data_version}}"

    - name: generate-label
      script:
        image: alpine:3.19
        command: [sh]
        source: |
          echo -n "emb$(date +%Y%m%d%H%M%S)"

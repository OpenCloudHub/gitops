apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: embeddings-pipeline
  namespace: mlops
  annotations:
    description: "Generate embeddings from downloaded data and store in pgvector"
spec:
  serviceAccountName: workflow-executor

  arguments:
    parameters:
      - name: data_version
        description: "Source data version tag (e.g., opencloudhub-readmes-download-v1.0.0)"
      - name: force
        value: "false"
        description: "Force re-run even if DVC cache exists"
      - name: compute_type
        value: "cpu-medium"
        enum: [cpu-small, cpu-medium, cpu-large, gpu-small, gpu-medium, gpu-large]
        description: "Compute configuration for Ray cluster"
      - name: image
        value: "opencloudhuborg/data-registry-pipelines:latest"
        description: "Docker image for embeddings pipeline"
      - name: bump_type
        value: "patch"
        enum: [major, minor, patch]
        description: "Version bump type for output tag"
      - name: is_automated
        value: "false"
        description: "Add -automated suffix to output tag"

  entrypoint: main

  templates:
    - name: main
      steps:
        # Step 1: Map compute type to resource specs
        - - name: map-compute
            templateRef:
              name: compute-templates
              template: map-compute-config
            arguments:
              parameters:
                - name: compute_type
                  value: "{{workflow.parameters.compute_type}}"

        # Step 2: Prepare RayJob parameters (trim whitespace, build JSON)
        - - name: prepare-rayjob
            template: prepare-rayjob-params
            arguments:
              parameters:
                - name: data_version
                  value: "{{workflow.parameters.data_version}}"
                - name: force
                  value: "{{workflow.parameters.force}}"
                - name: image
                  value: "{{workflow.parameters.image}}"
                - name: cpu_request
                  value: "{{steps.map-compute.outputs.parameters.cpu_request}}"
                - name: cpu_limit
                  value: "{{steps.map-compute.outputs.parameters.cpu_limit}}"
                - name: memory_request
                  value: "{{steps.map-compute.outputs.parameters.memory_request}}"
                - name: memory_limit
                  value: "{{steps.map-compute.outputs.parameters.memory_limit}}"
                - name: replicas
                  value: "{{steps.map-compute.outputs.parameters.replicas}}"

        # Step 3: Create RayJob from ConfigMap template
        - - name: create-rayjob
            templateRef:
              name: ray-templates
              template: create-rayjob-from-template
            arguments:
              parameters:
                - name: configmap_name
                  value: "embeddings-rayjob-template"
                - name: run_label
                  value: "{{steps.prepare-rayjob.outputs.parameters.run_label}}"
                - name: substitutions
                  value: "{{steps.prepare-rayjob.outputs.parameters.substitutions}}"

        # Step 4: Wait for job completion with Ray CLI log streaming
        - - name: wait-for-rayjob
            templateRef:
              name: ray-templates
              template: wait-for-rayjob
            arguments:
              parameters:
                - name: job_name
                  value: "{{steps.create-rayjob.outputs.parameters.job_name}}"
                - name: timeout_seconds
                  value: "3600"

        # Step 5: Tag the successful run (only on success)
        - - name: git-tag
            templateRef:
              name: git-templates
              template: git-tag-version
            when: "{{steps.wait-for-rayjob.outputs.parameters.job_status}} == SUCCEEDED"
            arguments:
              parameters:
                - name: tag_prefix
                  value: "opencloudhub-readmes-embeddings"
                - name: bump_type
                  value: "{{workflow.parameters.bump_type}}"
                - name: is_automated
                  value: "{{workflow.parameters.is_automated}}"
                - name: message
                  value: "Embeddings generated from {{workflow.parameters.data_version}}"

    # ==========================================================================
    # PREPARE RAYJOB PARAMETERS
    # Trims whitespace from all inputs and builds substitution JSON
    # ==========================================================================
    - name: prepare-rayjob-params
      inputs:
        parameters:
          - name: data_version
          - name: force
          - name: image
          - name: cpu_request
          - name: cpu_limit
          - name: memory_request
          - name: memory_limit
          - name: replicas
      outputs:
        parameters:
          - name: run_label
            valueFrom:
              path: /tmp/run-label.txt
          - name: substitutions
            valueFrom:
              path: /tmp/substitutions.json
      script:
        image: alpine:3.19
        command: [sh]
        source: |
          set -e
          apk add --no-cache jq > /dev/null 2>&1

          # Trim all inputs (remove leading/trailing whitespace and newlines)
          DATA_VERSION=$(printf '%s' "{{inputs.parameters.data_version}}" | xargs)
          FORCE=$(printf '%s' "{{inputs.parameters.force}}" | xargs)
          IMAGE=$(printf '%s' "{{inputs.parameters.image}}" | xargs)
          CPU_REQUEST=$(printf '%s' "{{inputs.parameters.cpu_request}}" | xargs)
          CPU_LIMIT=$(printf '%s' "{{inputs.parameters.cpu_limit}}" | xargs)
          MEMORY_REQUEST=$(printf '%s' "{{inputs.parameters.memory_request}}" | xargs)
          MEMORY_LIMIT=$(printf '%s' "{{inputs.parameters.memory_limit}}" | xargs)
          REPLICAS=$(printf '%s' "{{inputs.parameters.replicas}}" | xargs)

          # Generate unique run label
          RUN_LABEL="emb$(date +%Y%m%d%H%M%S)"
          echo "$RUN_LABEL" > /tmp/run-label.txt

          # Build entrypoint command
          FORCE_FLAG=""
          [ "$FORCE" = "true" ] && FORCE_FLAG="--force"
          ENTRYPOINT="sed -i 's|version: \".*\"|version: \"${DATA_VERSION}\"|' pipelines/opencloudhub-readmes-embeddings/params.yaml && /workspace/project/.venv/bin/dvc repro ${FORCE_FLAG} pipelines/opencloudhub-readmes-embeddings/dvc.yaml"

          # Build substitutions JSON
          jq -n \
            --arg image "$IMAGE" \
            --arg entrypoint "$ENTRYPOINT" \
            --arg cpu_request "$CPU_REQUEST" \
            --arg cpu_limit "$CPU_LIMIT" \
            --arg memory_request "$MEMORY_REQUEST" \
            --arg memory_limit "$MEMORY_LIMIT" \
            --arg replicas "$REPLICAS" \
            '{
              IMAGE: $image,
              ENTRYPOINT: $entrypoint,
              CPU_REQUEST: $cpu_request,
              CPU_LIMIT: $cpu_limit,
              MEMORY_REQUEST: $memory_request,
              MEMORY_LIMIT: $memory_limit,
              REPLICAS: $replicas
            }' > /tmp/substitutions.json

          echo "=========================================="
          echo "PREPARED RAYJOB PARAMETERS"
          echo "  Run Label:  $RUN_LABEL"
          echo "  Data:       $DATA_VERSION"
          echo "  Image:      $IMAGE"
          echo "  Force:      $FORCE"
          echo "  CPU:        $CPU_REQUEST / $CPU_LIMIT"
          echo "  Memory:     $MEMORY_REQUEST / $MEMORY_LIMIT"
          echo "  Replicas:   $REPLICAS"
          echo "=========================================="
          echo ""
          echo "Substitutions JSON:"
          cat /tmp/substitutions.json

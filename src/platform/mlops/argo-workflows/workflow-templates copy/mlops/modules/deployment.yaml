apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: deployment-templates
  namespace: mlops
  annotations:
    workflows.argoproj.io/description: 'Templates for model deployment.'
spec:
  serviceAccountName: workflow-executor

  templates:
  # Main deployment workflow - combines GitOps update + MLflow tagging
  - name: deploy-model
    inputs:
      parameters:
      - name: model_name          # e.g., wine-classifier
      - name: model_uri           # e.g., models:/prod.wine-classifier/1
      - name: serving_image       # e.g., opencloudhuborg/wine-classifier-serving:main-abc123
      - name: deployed_by         # e.g., "pipeline", "manual", or username
        value: "manual"
      - name: mlflow_tracking_uri
        value: "http://mlflow.mlops.svc.cluster.local:80"
    steps:
    # Step 1: Update GitOps repo
    - - name: update-gitops-repo
        template: update-gitops
        arguments:
          parameters:
          - name: model_name
            value: "{{inputs.parameters.model_name}}"
          - name: model_uri
            value: "{{inputs.parameters.model_uri}}"
          - name: serving_image
            value: "{{inputs.parameters.serving_image}}"

    # Step 2: Tag deployment in MLflow
    - - name: tag-mlflow-deployment-info
        templateRef:
          name: mlflow-templates
          template: tag-deployment-info
        arguments:
          parameters:
          - name: model_uri
            value: "{{inputs.parameters.model_uri}}"
          - name: serving_image
            value: "{{inputs.parameters.serving_image}}"
          - name: deployed_by
            value: "{{inputs.parameters.deployed_by}}"
          - name: mlflow_tracking_uri
            value: "{{inputs.parameters.mlflow_tracking_uri}}"

  # Sub-template: GitOps update
  - name: update-gitops
    inputs:
      parameters:
      - name: model_name
      - name: model_uri
      - name: serving_image
    volumes:
    - name: git-secret
      secret:
        secretName: gitops-repo
    script:
      image: alpine/git:latest
      command: [sh]
      volumeMounts:
      - name: git-secret
        mountPath: /mnt/secrets
        readOnly: true
      source: |
        set -e

        # SSH setup
        mkdir -p ~/.ssh
        cat /mnt/secrets/sshPrivateKey > ~/.ssh/id_ed25519
        echo "" >> ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan github.com >> ~/.ssh/known_hosts

        MODEL_NAME="{{inputs.parameters.model_name}}"
        MODEL_URI="{{inputs.parameters.model_uri}}"
        SERVING_IMAGE="{{inputs.parameters.serving_image}}"

        # Clean variables
        MODEL_NAME=$(echo "$MODEL_NAME" | tr -d '\n\r\t ')
        MODEL_URI=$(echo "$MODEL_URI" | tr -d '\n\r\t ')
        SERVING_IMAGE=$(echo "$SERVING_IMAGE" | tr -d '\n\r\t ')

        # Extract version from model URI using sed instead of grep -P
        # models:/prod.wine-classifier/1 ‚Üí 1
        VERSION=$(echo "$MODEL_URI" | sed -n 's|.*/\([0-9]*\)$|\1|p')

        git clone git@github.com:OpenCloudHub/gitops.git /tmp/gitops
        cd /tmp/gitops

        SERVICE_FILE="src/teams/ai/models-custom/${MODEL_NAME}-service.yaml"

        echo "üì¶ Deployment: ${MODEL_NAME}"
        echo "   Model: ${MODEL_URI}"
        echo "   Image: ${SERVING_IMAGE}"
        echo ""

        # Extract current state
        CURRENT_IMAGE=$(grep "image: opencloudhuborg/${MODEL_NAME}" "$SERVICE_FILE" | head -1 | awk '{print $2}')

        if grep -q "model_uri:" "$SERVICE_FILE"; then
          # Extract current URI using sed instead of grep -P
          CURRENT_URI=$(grep "model_uri:" "$SERVICE_FILE" | sed -n 's/.*model_uri: "\([^"]*\)".*/\1/p')
          echo "   Current: ${CURRENT_URI} with ${CURRENT_IMAGE}"
        else
          echo "   Current: (no model) with ${CURRENT_IMAGE}"
        fi

        # Update images
        sed -i "s|image: opencloudhuborg/${MODEL_NAME}-serving:[a-zA-Z0-9_-]*|image: ${SERVING_IMAGE}|g" "$SERVICE_FILE"

        # Update or add model_uri
        if grep -q "user_config:" "$SERVICE_FILE"; then
          echo "   Updating existing user_config..."
          sed -i "s|model_uri: \"models:/[^\"]*\"|model_uri: \"${MODEL_URI}\"|g" "$SERVICE_FILE"
        else
          echo "   Adding user_config..."
          # Add user_config after first deployment name, with proper indentation
          awk '
            /deployments:/ { in_deployments=1 }
            in_deployments && /- name:/ && !added {
              print
              print "            user_config:"
              print "              model_uri: \"'"${MODEL_URI}"'\""
              added=1
              next
            }
            { print }
          ' "$SERVICE_FILE" > "${SERVICE_FILE}.tmp"
          mv "${SERVICE_FILE}.tmp" "$SERVICE_FILE"
        fi

        git config user.name "Argo Workflow"
        git config user.email "workflow@opencloudhub.org"
        git add "$SERVICE_FILE"

        # Only commit if there are changes
        if git diff --cached --quiet; then
          echo ""
          echo "‚ÑπÔ∏è  No changes to commit - already up to date"
        else
          git commit -m "üöÄ Deploy ${MODEL_NAME} v${VERSION} (${SERVING_IMAGE##*:})"
          git push
          echo ""
          echo "‚úÖ GitOps updated!"
        fi

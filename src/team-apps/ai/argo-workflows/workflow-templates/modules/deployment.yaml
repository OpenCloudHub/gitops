apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: deployment-templates
  namespace: ai
spec:
  serviceAccountName: workflow-executor

  templates:
    - name: update-gitops
      inputs:
        parameters:
        - name: model_name
        - name: prod_version
        - name: training_image
      volumes:
      - name: git-secret
        secret:
          secretName: gitops-repo
      script:
        image: alpine/git:latest
        command: [sh]
        volumeMounts:
        - name: git-secret
          mountPath: /mnt/secrets
          readOnly: true
        source: |
          set -e

          # Install yq and sed
          apk add --no-cache yq sed

          # Setup SSH
          mkdir -p ~/.ssh
          cat /mnt/secrets/sshPrivateKey > ~/.ssh/id_ed25519
          echo "" >> ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          MODEL_NAME="{{inputs.parameters.model_name}}"
          PROD_VERSION="{{inputs.parameters.prod_version}}"
          TRAINING_IMAGE="{{inputs.parameters.training_image}}"
          NEW_URI="models:/prod.${MODEL_NAME}/${PROD_VERSION}"

          # Strip whitespace
          MODEL_NAME=$(echo "$MODEL_NAME" | tr -d '\n\r\t ')

          echo "üì¶ Deployment Request:"
          echo "   Model: ${MODEL_NAME}"
          echo "   Version: v${PROD_VERSION}"
          echo "   Image: ${TRAINING_IMAGE}"
          echo ""

          git clone git@github.com:OpenCloudHub/gitops.git /tmp/gitops
          cd /tmp/gitops

          SERVICE_FILE="src/team-apps/ai/ray/${MODEL_NAME}-service.yaml"

          # Get current values using simpler yq queries
          CURRENT_IMAGE=$(yq eval '.spec.rayClusterConfig.headGroupSpec.template.spec.containers[0].image' "$SERVICE_FILE")

          # Extract serveConfigV2 as string and parse for model_uri
          CURRENT_URI=$(yq eval '.spec.serveConfigV2' "$SERVICE_FILE" | grep -oP 'model_uri:\s*"\K[^"]+' || echo "")

          echo "üìä Current State:"
          echo "   Image: ${CURRENT_IMAGE}"
          echo "   Model: ${CURRENT_URI}"
          echo ""

          CHANGED=false

          # Update image if different - use sed instead of yq to avoid formatting issues
          if [ "$CURRENT_IMAGE" != "$TRAINING_IMAGE" ]; then
            echo "‚úèÔ∏è  Updating image: ${CURRENT_IMAGE} ‚Üí ${TRAINING_IMAGE}"

            # Escape special characters in image name for sed
            ESCAPED_OLD=$(echo "$CURRENT_IMAGE" | sed 's/[\/&]/\\&/g')
            ESCAPED_NEW=$(echo "$TRAINING_IMAGE" | sed 's/[\/&]/\\&/g')

            # Replace all occurrences of the old image
            sed -i "s|image: ${ESCAPED_OLD}|image: ${ESCAPED_NEW}|g" "$SERVICE_FILE"

            CHANGED=true
          else
            echo "‚úì Image unchanged"
          fi

          # Update model URI if different - use sed on the serveConfigV2 string
          if [ "$CURRENT_URI" != "$NEW_URI" ]; then
            echo "‚úèÔ∏è  Updating model: ${CURRENT_URI} ‚Üí ${NEW_URI}"

            if [ -n "$CURRENT_URI" ]; then
              # Replace existing model_uri
              ESCAPED_OLD_URI=$(echo "$CURRENT_URI" | sed 's/[\/&]/\\&/g')
              ESCAPED_NEW_URI=$(echo "$NEW_URI" | sed 's/[\/&]/\\&/g')
              sed -i "s|model_uri: \"${ESCAPED_OLD_URI}\"|model_uri: \"${ESCAPED_NEW_URI}\"|g" "$SERVICE_FILE"
            else
              # Add model_uri under user_config (if missing)
              sed -i "/user_config:/a\\            model_uri: \"${NEW_URI}\"" "$SERVICE_FILE"
            fi

            CHANGED=true
          else
            echo "‚úì Model URI unchanged"
          fi

          echo ""

          if [ "$CHANGED" = false ]; then
            echo "‚úÖ Already at target state - no changes needed"
            exit 0
          fi

          # Commit and push
          git config user.name "Argo Workflow"
          git config user.email "workflow@opencloudhub.org"
          git add "$SERVICE_FILE"
          git commit -m "ü§ñ Deploy ${MODEL_NAME} v${PROD_VERSION}"
          git push

          echo ""
          echo "‚úÖ GitOps repo updated! ArgoCD will sync the changes."

apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: deployment-templates
  namespace: ai
spec:
  serviceAccountName: workflow-executor

  templates:
  - name: reload-ray-serve
    inputs:
      parameters:
      - name: model_name
      - name: prod_version
      - name: ray_service_namespace
        value: "ai"
    script:
      image: alpine/curl:latest
      command: [sh]
      source: |
        set -e

        MODEL_NAME="{{inputs.parameters.model_name}}"
        PROD_VERSION="{{inputs.parameters.prod_version}}"
        NAMESPACE="{{inputs.parameters.ray_service_namespace}}"
        SERVICE_NAME="${MODEL_NAME}-service"

        echo "ðŸ”„ Updating model via Ray Serve API"
        echo "   Model URI: models:/prod.${MODEL_NAME}/${PROD_VERSION}"

        # Ray dashboard URL
        RAY_DASHBOARD="http://${SERVICE_NAME}-head-svc.${NAMESPACE}.svc.cluster.local:8265"

        # Get current application list
        echo "ðŸ“¥ Fetching current application config..."
        CURRENT_APPS=$(curl -s "${RAY_DASHBOARD}/api/serve/applications/")

        # Extract the application name (first app in the list)
        APP_NAME=$(echo "${CURRENT_APPS}" | grep -o '"name":"[^"]*"' | head -1 | cut -d'"' -f4)

        if [ -z "$APP_NAME" ]; then
          echo "âŒ No application found"
          exit 1
        fi

        echo "ðŸ“¦ Found application: ${APP_NAME}"

        # Build the update payload - only update user_config
        cat > /tmp/config.json << 'HEREDOC'
        {
          "applications": [
            {
              "name": "APP_NAME_PLACEHOLDER",
              "config_or_import_path": {
                "user_config": {
                  "model_uri": "MODEL_URI_PLACEHOLDER"
                }
              }
            }
          ]
        }
        HEREDOC

        # Replace placeholders
        sed -i "s|APP_NAME_PLACEHOLDER|${APP_NAME}|g" /tmp/config.json
        sed -i "s|MODEL_URI_PLACEHOLDER|models:/prod.${MODEL_NAME}/${PROD_VERSION}|g" /tmp/config.json

        echo "ðŸš€ Deploying updated config..."
        RESPONSE=$(curl -X PUT "${RAY_DASHBOARD}/api/serve/applications/" \
          -H "Content-Type: application/json" \
          -d @/tmp/config.json \
          -w "\n%{http_code}" -s)

        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)

        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… Model URI updated successfully!"
          echo "   Your reconfigure() method will be called with new model_uri"
        else
          echo "âŒ Failed to update (HTTP ${HTTP_CODE})"
          echo "$BODY"
          exit 1
        fi

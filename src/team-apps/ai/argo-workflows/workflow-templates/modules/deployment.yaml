apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: deployment-templates
  namespace: ai
spec:
  serviceAccountName: workflow-executor

  templates:
    - name: update-gitops
      inputs:
        parameters:
        - name: model_name
        - name: prod_version
        - name: training_image
      volumes:
      - name: git-secret
        secret:
          secretName: gitops-repo
      script:
        image: alpine/git:latest
        command: [sh]
        volumeMounts:
        - name: git-secret
          mountPath: /mnt/secrets
          readOnly: true
        source: |
          set -e

          # SSH setup only
          mkdir -p ~/.ssh
          cat /mnt/secrets/sshPrivateKey > ~/.ssh/id_ed25519
          echo "" >> ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          MODEL_NAME="{{inputs.parameters.model_name}}"
          PROD_VERSION="{{inputs.parameters.prod_version}}"
          TRAINING_IMAGE="{{inputs.parameters.training_image}}"

          MODEL_NAME=$(echo "$MODEL_NAME" | tr -d '\n\r\t ')
          NEW_URI="models:/prod.${MODEL_NAME}/${PROD_VERSION}"

          echo "ðŸ“¦ Deploying ${MODEL_NAME} v${PROD_VERSION}"

          git clone git@github.com:OpenCloudHub/gitops.git /tmp/gitops
          cd /tmp/gitops

          SERVICE_FILE="src/team-apps/ai/ray/${MODEL_NAME}-service.yaml"

          # Show what we're changing
          echo "Current state:"
          grep -E 'image:|model_uri:' "$SERVICE_FILE" | head -3

          # Replace ONLY the exact lines we need
          # 1. Replace model_uri line
          sed -i "s|model_uri: \"models:/prod\.${MODEL_NAME}/[0-9]*\"|model_uri: \"${NEW_URI}\"|g" "$SERVICE_FILE"

          # 2. Replace image lines (escape special chars in image name)
          ESCAPED_IMAGE=$(echo "$TRAINING_IMAGE" | sed 's/[\/&]/\\&/g')
          sed -i "s|image: .*${MODEL_NAME}:.*|image: ${ESCAPED_IMAGE}|g" "$SERVICE_FILE"

          echo ""
          echo "New state:"
          grep -E 'image:|model_uri:' "$SERVICE_FILE" | head -3

          git config user.name "Argo Workflow"
          git config user.email "workflow@opencloudhub.org"
          git add "$SERVICE_FILE"
          git commit -m "ðŸ¤– Deploy ${MODEL_NAME} v${PROD_VERSION}"
          git push

          echo "âœ… Done"

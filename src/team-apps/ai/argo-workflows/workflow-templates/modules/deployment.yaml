apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: deployment-templates
  namespace: ai
spec:
  serviceAccountName: workflow-executor

  templates:
  - name: reload-ray-serve
    inputs:
      parameters:
      - name: model_name
      - name: prod_version
      - name: ray_service_namespace
        value: "ai"
    script:
      image: bitnami/kubectl:latest
      command: [sh]
      source: |
        set -e

        MODEL_NAME="{{inputs.parameters.model_name}}"
        PROD_VERSION="{{inputs.parameters.prod_version}}"
        NAMESPACE="{{inputs.parameters.ray_service_namespace}}"
        SERVICE_NAME="${MODEL_NAME}-service"

        echo "ðŸ”„ Updating ${SERVICE_NAME} to version ${PROD_VERSION}"

        # Get current config
        CURRENT_CONFIG=$(kubectl get rayservice "${SERVICE_NAME}" -n "${NAMESPACE}" -o jsonpath='{.spec.serveConfigV2}')

        # Update only the model_uri line
        NEW_CONFIG=$(echo "${CURRENT_CONFIG}" | sed -E "s|(model_uri: models:/prod\.${MODEL_NAME}/)([0-9]+)|\1${PROD_VERSION}|")

        # Patch
        kubectl patch rayservice "${SERVICE_NAME}" -n "${NAMESPACE}" --type=merge -p "{\"spec\":{\"serveConfigV2\":$(echo "${NEW_CONFIG}" | jq -Rs .)}}"

        echo "âœ… Model URI updated to: models:/prod.${MODEL_NAME}/${PROD_VERSION}"

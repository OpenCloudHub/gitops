apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: deployment-templates
  namespace: ai
spec:
  serviceAccountName: workflow-executor

  templates:
    - name: update-gitops
      inputs:
        parameters:
        - name: model_name
        - name: prod_version
        - name: serving_image
      volumes:
      - name: git-secret
        secret:
          secretName: gitops-repo
      script:
        image: alpine/git:latest
        command: [sh]
        volumeMounts:
        - name: git-secret
          mountPath: /mnt/secrets
          readOnly: true
        source: |
          set -e

          # SSH setup
          mkdir -p ~/.ssh
          cat /mnt/secrets/sshPrivateKey > ~/.ssh/id_ed25519
          echo "" >> ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          MODEL_NAME="{{inputs.parameters.model_name}}"
          PROD_VERSION="{{inputs.parameters.prod_version}}"
          SERVING_IMAGE="{{inputs.parameters.serving_image}}"

          # Clean variables
          MODEL_NAME=$(echo "$MODEL_NAME" | tr -d '\n\r\t ')
          PROD_VERSION=$(echo "$PROD_VERSION" | tr -d '\n\r\t ')
          SERVING_IMAGE=$(echo "$SERVING_IMAGE" | tr -d '\n\r\t ')

          git clone git@github.com:OpenCloudHub/gitops.git /tmp/gitops
          cd /tmp/gitops

          SERVICE_FILE="src/team-apps/ai/ray/${MODEL_NAME}-service.yaml"

          echo "ðŸ“¦ Deployment Request: ${MODEL_NAME}"
          echo ""

          # Extract current image (appears multiple times - head and worker)
          CURRENT_IMAGE=$(grep "image: opencloudhuborg/${MODEL_NAME}" "$SERVICE_FILE" | head -1 | awk '{print $2}')

          # Check if model_uri exists in serveConfigV2
          if grep -q "model_uri:" "$SERVICE_FILE"; then
            CURRENT_VERSION=$(grep "model_uri:" "$SERVICE_FILE" | grep -oP 'prod\.[^/]*/\K[0-9]+' | head -1)
            echo "   Model Version:"
            echo "     Current: v${CURRENT_VERSION}"
            echo "     Target:  v${PROD_VERSION}"

            if [ "$CURRENT_VERSION" = "$PROD_VERSION" ]; then
              echo "     Status:  âœ“ Already up-to-date"
              MODEL_CHANGED=false
            else
              echo "     Status:  â†’ Updating"
              MODEL_CHANGED=true
            fi
          else
            echo "   Model Version:"
            echo "     Current: (not set)"
            echo "     Target:  v${PROD_VERSION}"
            echo "     Status:  â†’ Adding model_uri"
            MODEL_CHANGED=true
          fi

          echo ""
          echo "   Container Image:"
          echo "     Current: ${CURRENT_IMAGE}"
          echo "     Target:  ${SERVING_IMAGE}"

          if [ "$CURRENT_IMAGE" = "$SERVING_IMAGE" ]; then
            echo "     Status:  âœ“ Already up-to-date"
            IMAGE_CHANGED=false
          else
            echo "     Status:  â†’ Updating"
            IMAGE_CHANGED=true
          fi
          echo ""

          # Check if any changes needed
          if [ "$MODEL_CHANGED" = "false" ] && [ "$IMAGE_CHANGED" = "false" ]; then
            echo "âœ… No changes needed - already at target state"
            exit 0
          fi

          # Update images (both head and worker)
          sed -i "s|image: opencloudhuborg/${MODEL_NAME}:[a-zA-Z0-9_-]*|image: ${SERVING_IMAGE}|g" "$SERVICE_FILE"

          # DEBUG: Show what changed
          echo "=== DEBUG: After changes ==="
          grep "image:" "$SERVICE_FILE"
          echo ""

          # Update or add user_config with model_uri under WineClassifier deployment
          # âš ï¸ IMPORTANT: Depends on correct naming
          if grep -q "user_config:" "$SERVICE_FILE"; then
            echo "Update existing model_uri..."
            sed -i "s|model_uri: \"models://prod\.${MODEL_NAME}/[0-9]*\"|model_uri: \"models://prod.${MODEL_NAME}/${PROD_VERSION}\"|g" "$SERVICE_FILE"
          else
            echo "Adding model_uri to serveConfigV2..."
            # Find the line with "- name: WineClassifier" and add user_config after it
            sed -i "/- name: WineClassifier/a\\            user_config:\\n              model_uri: \"models://prod.${MODEL_NAME}/${PROD_VERSION}\"" "$SERVICE_FILE"
          fi

          git config user.name "Argo Workflow"
          git config user.email "workflow@opencloudhub.org"
          git add "$SERVICE_FILE"
          git commit -m "ðŸ¤– Deploy ${MODEL_NAME} v${PROD_VERSION} with ${SERVING_IMAGE##*:}"
          git push

          echo ""
          echo "âœ… GitOps updated! ArgoCD will sync changes."
          # set -e

          # # SSH setup
          # mkdir -p ~/.ssh
          # cat /mnt/secrets/sshPrivateKey > ~/.ssh/id_ed25519
          # echo "" >> ~/.ssh/id_ed25519
          # chmod 600 ~/.ssh/id_ed25519
          # ssh-keyscan github.com >> ~/.ssh/known_hosts

          # MODEL_NAME="{{inputs.parameters.model_name}}"
          # PROD_VERSION="{{inputs.parameters.prod_version}}"
          # TRAINING_IMAGE="{{inputs.parameters.serving_image}}"

          # # Clean ALL variables
          # MODEL_NAME=$(echo "$MODEL_NAME" | tr -d '\n\r\t ')
          # PROD_VERSION=$(echo "$PROD_VERSION" | tr -d '\n\r\t ')
          # TRAINING_IMAGE=$(echo "$TRAINING_IMAGE" | tr -d '\n\r\t ')

          # git clone git@github.com:OpenCloudHub/gitops.git /tmp/gitops
          # cd /tmp/gitops

          # SERVICE_FILE="src/team-apps/ai/ray/${MODEL_NAME}-service.yaml"

          # # Extract current values BEFORE changes
          # CURRENT_VERSION=$(grep 'model_uri:' "$SERVICE_FILE" | head -1 | grep -o '/[0-9]*"' | tr -d '/"')
          # CURRENT_IMAGE=$(grep "image: opencloudhuborg/${MODEL_NAME}" "$SERVICE_FILE" | head -1 | awk '{print $2}')

          # echo "ðŸ“¦ Deployment Request: ${MODEL_NAME}"
          # echo ""
          # echo "   Model Version:"
          # echo "     Current: v${CURRENT_VERSION}"
          # echo "     Target:  v${PROD_VERSION}"
          # if [ "$CURRENT_VERSION" = "$PROD_VERSION" ]; then
          #   echo "     Status:  âœ“ Already up-to-date"
          # else
          #   echo "     Status:  â†’ Updating"
          # fi
          # echo ""
          # echo "   Container Image:"
          # echo "     Current: ${CURRENT_IMAGE}"
          # echo "     Target:  ${TRAINING_IMAGE}"
          # if [ "$CURRENT_IMAGE" = "$TRAINING_IMAGE" ]; then
          #   echo "     Status:  âœ“ Already up-to-date"
          # else
          #   echo "     Status:  â†’ Updating"
          # fi
          # echo ""

          # # Check if any changes needed
          # if [ "$CURRENT_VERSION" = "$PROD_VERSION" ] && [ "$CURRENT_IMAGE" = "$TRAINING_IMAGE" ]; then
          #   echo "âœ… No changes needed - already at target state"
          #   exit 0
          # fi

          # # Do replacements
          # cat "$SERVICE_FILE" | \
          #   sed "s|opencloudhuborg/${MODEL_NAME}:[a-zA-Z0-9_-]*|${TRAINING_IMAGE}|g" | \
          #   sed "s|prod\.${MODEL_NAME}/[0-9]*|prod.${MODEL_NAME}/${PROD_VERSION}|g" \
          #   > "${SERVICE_FILE}.new"

          # mv "${SERVICE_FILE}.new" "$SERVICE_FILE"

          # git config user.name "Argo Workflow"
          # git config user.email "workflow@opencloudhub.org"
          # git add "$SERVICE_FILE"
          # git commit -m "ðŸ¤– ${MODEL_NAME} v${PROD_VERSION}"
          # git push

          # echo ""
          # echo "âœ… GitOps updated! ArgoCD will sync changes."

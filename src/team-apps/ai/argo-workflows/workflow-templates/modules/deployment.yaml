apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: deployment-templates
  namespace: ai
spec:
  serviceAccountName: workflow-executor

  templates:
  - name: reload-ray-serve
    inputs:
      parameters:
      - name: model_name
      - name: prod_version
      - name: ray_service_namespace
        value: "ai"
    script:
      image: alpine:latest
      command: [sh]
      source: |
        set -e

        # Install tools
        apk add --no-cache curl jq

        MODEL_NAME="{{inputs.parameters.model_name}}"
        PROD_VERSION="{{inputs.parameters.prod_version}}"
        NAMESPACE="{{inputs.parameters.ray_service_namespace}}"
        SERVICE_NAME="${MODEL_NAME}-service"

        echo "üîÑ Updating model to version ${PROD_VERSION}"

        RAY_DASHBOARD="http://${SERVICE_NAME}-head-svc.${NAMESPACE}.svc.cluster.local:8265"

        # Get current deployed config
        echo "üì• Fetching current deployed config..."
        curl -s "${RAY_DASHBOARD}/api/serve/applications/" > /tmp/current.json

        echo "Current config:"
        cat /tmp/current.json | jq '.'

        # Update model_uri in the config
        NEW_MODEL_URI="models:/prod.${MODEL_NAME}/${PROD_VERSION}"

        cat /tmp/current.json | jq \
          --arg uri "$NEW_MODEL_URI" \
          '.applications[0].deployments[0].user_config.model_uri = $uri' \
          > /tmp/updated.json

        echo ""
        echo "üöÄ Redeploying with updated model_uri..."
        echo "Updated config:"
        cat /tmp/updated.json | jq '.'

        RESPONSE=$(curl -X PUT "${RAY_DASHBOARD}/api/serve/applications/" \
          -H "Content-Type: application/json" \
          -d @/tmp/updated.json \
          -w "\n%{http_code}" -s)

        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)

        if [ "$HTTP_CODE" = "200" ]; then
          echo "‚úÖ Model reloaded to version ${PROD_VERSION}!"
        else
          echo "‚ùå Failed (HTTP ${HTTP_CODE})"
          echo "$BODY"
          exit 1
        fi

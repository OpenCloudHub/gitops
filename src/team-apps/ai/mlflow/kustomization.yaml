apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: ai
resources:
  - external-secrets.yaml
  - http-route.yaml

helmCharts:
- name: mlflow
  releaseName: mlflow
  version: 1.7.3
  repo: https://community-charts.github.io/helm-charts
  valuesInline:
    extraArgs:
      host: "0.0.0.0"
      gunicornOpts: null  # Remove gunicorn, use default uvicorn
    extraFlags:
      - disableSecurityMiddleware
    backendStore:
      postgres:
        enabled: true
        host: "mlflow-db-pooler.storage.svc.cluster.local"
        port: 5432
        database: "mlflow"
        driver: "psycopg2"
      existingDatabaseSecret:
        name: "mlflow-db-user"
        usernameKey: "username"
        passwordKey: "password"
    artifactRoot:
      proxiedArtifactStorage: true
      s3:
        enabled: true
        bucket: "mlflow"
        existingSecret:
          name: "minio-tenant-secret"
          keyOfAccessKeyId: "accesskey"
          keyOfSecretAccessKey: "secretkey"
    extraEnvVars:
      MLFLOW_S3_ENDPOINT_URL: "http://minio-hl.minio-tenant.svc.cluster.local:9000"
      MLFLOW_S3_IGNORE_TLS: "true"
    service:
      port: 80
      containerPort: 5000
    serviceMonitor:
      enabled: true
      namespace: ai
      labels:
        release: prometheus
